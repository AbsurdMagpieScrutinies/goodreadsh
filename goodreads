#!/usr/bin/env bash

# MIT License

# Copyright (c) 2018 Danish Prakash

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
 
KEY="IYew6u6cRN1P8y7aIBoc2A"

function show_help () {
    echo "Usage:"
    echo "goodreads <option> <argument>"
    echo
    echo "Commands: "
    echo "author <string>   : returns top books from author name"
    echo "rating <title     : returns rating for book by name"
    echo "desc <string>     : returns description of book by name"
    echo "user <id>         : returns books from user id"
}

if [[ $# = 0 ]]; then
    show_help;
    exit
else
    arg=$1
    case $arg in

        book|b )
            option=$2
            case $option in

                --rating-dist|-R )
                    curl  -s -X "GET" -d "title=$3" -d "key=$KEY" "https://www.goodreads.com/book/title.xml" \
                        | grep "<rating_dist>.*" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/\|/:/g" \
                        | awk -F ':' '{print "✪✪✪✪✪ \t: "$2 "\n" "✪✪✪✪ \t: "$4 "\n" "✪✪✪ \t: "$6 "\n" "✪✪ \t: "$8 "\n" "✪ \t: "$10 "\n\nTotal\t: " $12}'
                    ;;

                --rating|-r )
                    curl -s -X "GET" -d "key=$KEY" -d "q=$3" "https://www.goodreads.com/search.xml" \
                        | grep -o "<average_rating>.*" \
                        | sed "s:.*<average_rating>\(.*\)<\/average_rating>:\1:p" \
                        | awk 'NR==1 {print $0}'
                    ;;

                --author|-a )
                    curl -s -X "GET" --data "key=$KEY" --data "q=$3" "https://www.goodreads.com/search.xml" \
                        | grep "<name>.*" \
                        | sed "s/^[ \t]*//g" \
                        | sed "s/<[^>]*>//g" \
                        | awk 'NR==1 {print $0}'
                    ;;

                --desc|-d  )
                    # description of the book by title
                    curl -s -X "GET" --data "key=$KEY" --data "title=$3" "https://www.goodreads.com/book/title.xml" \
                        | grep -o "<description.*CDATA.*<\/description>"  \
                        | sed "s/<\!\[CDATA\[//g" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/\]\].*//g"
                    ;;

                --id )
                    curl -s -X "GET" --data "key=$KEY" --data "q=$3" "https://www.goodreads.com/search.xml" \
                        | grep -o "<id .*" \
                        | sed "s:.*<id.*>\(.*\)<\/id>:\1:p" \
                        | awk 'NR==2 {print $0}'
                    ;;

                * )
                    echo "Option not found: \`$2\`"
                    echo
                    show_help;
                    ;;

            esac
            ;;

        author|a )
            title=$(echo $3 | sed "s/\ /%20/g")
            uri="https://www.goodreads.com/api/author_url/$title"
            author_id=$(curl -s -X "GET" -d "key=$KEY" $uri | grep "<author.*" | awk -F '"' '{print $2}')

            option=$2
            case $option in

                --books|-b )
                    author_uri="https://www.goodreads.com/author/show/$author_id"
                    curl -s -X "GET" -d "key=$KEY" $author_uri \
                        | grep "<title.*<\/title>" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/^[ \t]*//g"
                    ;;

                --all-books|-B )
                    author_uri="https://www.goodreads.com/search/index.xml"
                    curl -s -X "GET" -d "key=$KEY" -d "q=$3" -d "search=author" $author_uri \
                        | grep "<title.*<\/title>" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/^[ \t]*//g"
                    ;;

                --info|-i )
                    author_uri="https://www.goodreads.com/author/show.xml"
                    curl -s -X "GET" -d "key=$KEY" -d "id=$author_id" $author_uri \
                        | grep "<works_count>.*\|<gender>.*\|<hometown>.*\|<born_at>.*\|<died_at>.*" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/[ \t]*//g" \
                        | awk 'NR==1 {print "Works: " $0} \
                        NR==2 {print "Gender: " $0} \
                        NR==3 {print "Hometown: " $0} \
                        NR==4 {print "Born: " $0} \
                        NR==5 {print "Died: " $0}'
                    ;;

                --about|-a  )
                    author_uri="https://www.goodreads.com/author/show.xml"
                    curl -s -X "GET" -d "key=$KEY" -d "id=$author_id" $author_uri \
                        | grep -o "<about.*CDATA.*<\/about>"  \
                        | sed "s/<\!\[CDATA\[//g" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/\]\].*//g"
                    ;;

                --id )
                    echo $author_id
                    ;;

                * )
                    echo "Option not found: \`$2\`"
                    echo
                    show_help;
                    ;;
            esac
            ;;

        user|u )
            user_id="Try again."
            function get_user_id () {
                user_id=$(curl -s -X "GET" -d "key=$KEY" -d "username=$1" "https://www.goodreads.com/user/show/" \
                    | grep "<id>.*" \
                    | sed "s/<[^>]*>//g" \
                    | sed "s/[ \t]*//g" \
                    | awk 'NR==1 {print $0}')
            }

            option=$2
            case $option in

                --shelf|-s )
                    user_uri="https://www.goodreads.com/review/list"
                    if [[ $4 == ^[0-9]+ ]]; then user_id=$4; else get_user_id $4; fi;
                    curl -s -X "GET" -d "key=$KEY" -d "shelf=$3" -d "id=$user_id" -d "per_page=100" $user_uri \
                        | grep "<title>.*" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/^[ \t]*//g"
                    ;;

                --id|-i )
                    get_user_id $3;
                    echo $user_id
                    ;;

                --about|-a )
                    if [[ $3 =~ ^[0-9]+ ]]; then user_id=$3; else get_user_id $3; fi;
                    curl -s -X "GET" -d "key=$KEY" -d "id=$user_id" "https://www.goodreads.com/user/show/" \
                        | grep "<name>.*\|<age>.*\|<gender>.*\|<location>.*\|<joined>.*" \
                        | sed "s/<[^>]*>//g" \
                        | sed "s/^[ \t]*//g" \
                        | awk 'NR==1 {print "Name: " $0} \
                        NR==2 {print "Age: " $0} \
                        NR==3 {print "Gender: " $0} \
                        NR==4 {print "Location: " $0}'
                    ;;

                * )
                    echo "Option not found: \`$2\`"
                    echo
                    show_help;
                    ;;

                esac
                ;;

        help|h )
            show_help;
    esac
fi

